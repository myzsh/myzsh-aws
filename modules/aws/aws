#!/usr/bin/zsh
globalvar AWS_PROFILE "dev" "Default profile to use when sending commands to aws"

aws(){
	local verb="$1"
	local mod="$2"

	case "$verb" in
	ec2)
		#remove verb and mod
		argv=(${argv:3:$#argv})

		if [ "$(echo $argv | grep -e '--profile\ ')" ]; then
			command aws $verb $mod $argv
		else
			command aws $verb $mod $argv --profile $AWS_PROFILE
		fi
	;;
	ssh)
		if [ -n "$mod" ]; then
			#remove verb and mod
			argv=(${argv:3:$#argv})

			# Use provided profile
			profile=$AWS_PROFILE
			[ -n "${argv[1]}" ] && profile="${argv[1]}" && argv=(${argv:2:$#argv})

			instance="$mod"
			[[ "${instance:0:2}" != "i-" ]] && [ ${#instance} -eq 8 ] && instance="i-$mod"
			unset addr
			[ ${#instance} -eq 10 ] && addr=$(command aws ec2 describe-instances --instance-ids "$instance" --profile "$profile" 2>&1 | grep PublicDnsName | head -n 1 | cut -d "\"" -f 4)
	
			[ -z "$addr" ] && addr="$instance"
			ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$addr" "$argv"
		fi
	;;
		fi
	;;
	*)
		command aws "$@"
	;;
	esac
}

# vim: filetype=zsh noexpandtab
